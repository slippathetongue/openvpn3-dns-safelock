Helper scripts for **OpenVPN 3 Linux** that:

- Start an OpenVPN 3 session.
- Lock `/etc/resolv.conf` so the system only uses the **VPN-provided DNS servers**.
- Restore `/etc/resolv.conf` and clear the immutable flag when disconnecting.
- Handle crashes / power loss safely (recovery is always just one command away).

These scripts are aimed at security researchers and pentesters who want to reduce the risk of DNS leaks when using OpenVPN 3 on Kali / Parrot and similar Debian-based systems.

## Background

During testing on both **Kali Linux** and **Parrot Security OS**, we observed that the OpenVPN 3 Linux client handles DNS very differently from many other VPN implementations.

**Specifically:**

- When an OpenVPN 3 session is established, the client **modifies `/etc/resolv.conf` directly**.
- Instead of replacing the system’s nameservers, OpenVPN 3 typically **prepends** the VPN-supplied DNS servers above the system defaults:

```bash
cat /etc/resolv.conf                      
#
# Generated by OpenVPN 3 Linux (NetCfg::DNS::ResolvConfFile)
# Last updated: 2025-11-23 04:09:43 
#

# OpenVPN defined name servers
nameserver <vpn-dns-1>
nameserver <vpn-dns-2>

# System defined name servers
nameserver 1.1.1.1
nameserver 9.9.9.9
```

- This behavior means the resolver may still use **non-VPN DNS servers** in certain conditions (depending on resolver order, caching, or fallback behavior).

For anyone interested in avoiding potential DNS leaks, simply prepending nameservers is not always reliable. This tool was created to address that limitation.

## Scripts

### `openvpn3-connect.sh`

- Must be run as root (`sudo`).
- Starts an OpenVPN 3 session using an existing OpenVPN 3 profile.
- Backs up `/etc/resolv.conf` to `/etc/resolv.conf.vpn3backup`.
- Waits for OpenVPN 3 to inject the `# OpenVPN defined name servers` block into `/etc/resolv.conf`.
- Rewrites `/etc/resolv.conf` so that it contains **only** the VPN nameservers.
- Sets the immutable flag (`chattr +i`) on `/etc/resolv.conf` to prevent NetworkManager / DHCP / other tools from changing DNS while the VPN is active.
- Drops a simple lock marker at `/run/openvpn3-locked.d/dnslock`.

If it cannot find the OpenVPN DNS block in `/etc/resolv.conf` within a short timeout, it **restores the original `/etc/resolv.conf` from the backup and exits**. No manual cleanup is required in that case.

### `openvpn3-disconnect.sh`

- Must be run as root (`sudo`).
- Tries to disconnect an active OpenVPN 3 session:
  - First in the **user** context (the user who invoked `sudo`, if any).
  - Then in the **root** context.
- Regardless of whether a session is found, if `/etc/resolv.conf.vpn3backup` exists it:
  - Clears the immutable flag on `/etc/resolv.conf` (`chattr -i`).
  - Restores `/etc/resolv.conf` from `/etc/resolv.conf.vpn3backup`.
  - Deletes the backup file.
  - Clears the `/run/openvpn3-locked.d/dnslock` marker (if present).
  - Resets ownership and permissions on `/etc/resolv.conf` to `root:root` and `0644`.

This means that even after a crash, daemon kill, or power loss, you can always run:

```bash
sudo openvpn3-disconnect.sh
```

## Requirements & assumptions

These scripts are intentionally conservative. They only operate when the DNS model is understood and safe.

### Required

- A Debian-based Linux distribution:
  - Tested:
    - **Kali Linux** (stock install version 2025.3, `/etc/resolv.conf` is a regular file) - Debian 13/trixie OpenVPN 3 repo.
    - **Parrot Security 6.4 (lorikeet)** - Debian 12/bookworm OpenVPN 3 repo.
- `openvpn3` CLI installed and working:
  - You can run:
    - `openvpn3 version`
    - `openvpn3 configs-list`
- `/etc/resolv.conf` must be:
  - A **regular file**, not a symlink.
  - **Not already immutable** (`chattr +i`).
  - Under the control of OpenVPN 3's `ResolvConfFile` backend or similar (i.e., OpenVPN 3 is actually writing its DNS block into it).

### The scripts will refuse to run if:

- You are not root (`sudo`).
- `openvpn3` is not in `PATH`.
- `/etc/resolv.conf` does not exist.
- `/etc/resolv.conf` is a **symlink** (for example, managed by `systemd-resolved` or `resolvconf`).
- `/etc/resolv.conf` is already **immutable**.
- A previous backup file `/etc/resolv.conf.vpn3backup` already exists (indicating an incomplete or dirty previous run).

This is by design, to avoid breaking DNS on systems with different resolver architectures.

## Supported / tested scenarios

### Confirmed working
- **Kali Linux** (out-of-the-box):
  - `/etc/resolv.conf` is a plain file.
  - OpenVPN 3 writes a `# OpenVPN defined name servers` block into it.
- **Parrot Security 6.4 (lorikeet)**:
  - OpenVPN 3 installed from the official `openvpn3` Debian 12/bookworm repo.
  - `/etc/resolv.conf` is a plain file.
  - `openvpn-dco-dkms` may fail to build for some kernels; this does not affect the scripts, which only depend on the `openvpn3` CLI.

### Not supported (scripts abort safely)
- `/etc/resolv.conf` is a symlink, e.g.:
  - To `systemd-resolved`'s stub file.
  - To a `resolvconf`-managed file.
  - `/etc/resolv.conf` has been made immutable by the administrator.
  - Non-Debian-derived distributions where the DNS model is unknown or very different.

You can still experiment on other distros, but you do so at your own risk. The scripts are intentionally defensive and may simply refuse to touch your DNS.

## Usage

### Install the scripts

1. You can get the scripts by cloning this repo: 

**HTTPS:**
```bash
git clone https://github.com/slippathetongue/openvpn3-dns-safelock.git
```
**SSH:**
```bash
git clone git@github.com:slippathetongue/openvpn3-dns-safelock.git
```

2. Enter the project directory:

```bash
cd openvpn3-dns-safelock
```

3. Make the scripts executable

```bash
chmod +x openvpn3-connect.sh openvpn3-disconnect.sh
```

4. **(Recommended)** Copy them into a directory in your `PATH`, e.g. `/usr/local/sbin`
- This way you will be able to execute the scripts from any location/folder on the machine

```bash
sudo cp openvpn3-connect.sh /usr/local/sbin/
sudo cp openvpn3-disconnect.sh /usr/local/sbin/
```

### Prepare an OpenVPN 3 profile

Use OpenVPN 3 Linux as you normally would. For example:

```bash
openvpn3 config-import --config /path/to/your.ovpn --name myprofile
openvpn3 configs-list
```

- Make sure you see your profile in `configs-list`.

### Connect with DNS safelock

From your regular user:

```bash
# sudo openvpn3-connect.sh myprofile
[+] openvpn3-connect.sh starting
[+] Using profile 'myprofile' for user 'root'
[+] Backing up /etc/resolv.conf to /etc/resolv.conf.vpn3backup
[+] Starting OpenVPN 3 session
Using pre-loaded configuration profile 'myprofile'
Session path: /net/openvpn/v3/sessions/20d1a4a7s1c6es41f3s92a4s8196c859e189
Auth User name: vpnuser
Auth Password: 
Connected to X.X.X.X (X.X.X.X)
[+] Waiting for VPN DNS entries to appear in /etc/resolv.conf...
[+] Locking /etc/resolv.conf to VPN DNS only

[+] DNS is now locked to the following VPN nameservers:
nameserver <vpn-dns-1>
nameserver <vpn-dns-2>

[+] openvpn3-connect.sh done

# openvpn3 sessions-list
-----------------------------------------------------------------------------
        Path: /net/openvpn/v3/sessions/20d1a4a7s1c6es41f3s92a4s8196c859e189
     Created: 2025-11-23 02:36:08                       PID: 161584
       Owner: root                                   Device: tun0
 Config name: myprofile
Connected to: tcp:X.X.X.X:443
      Status: Connection, Client connected
-----------------------------------------------------------------------------
```

**What happens:**
- The script backs up `/etc/resolv.conf`.
- Starts `openvpn3 session-start --config myprofile` as the real user.
- Waits for VPN DNS to be injected.
- Rewrites `/etc/resolv.conf` with only VPN nameservers.
- Sets `chattr +i` on `/etc/resolv.conf`.

**You should now see:**

```bash
cat /etc/resolv.conf
# resolv.conf locked by openvpn3-connect.sh ...
nameserver <vpn-dns-1>
nameserver <vpn-dns-2>
...

ls -lh /etc | grep resolv
-rw-r--r--  1 openvpn  openvpn   183 Nov 23 02:36 resolv.conf
-rw-r--r--  1 root     root       53 Nov 21 14:18 resolv.conf.bak
-rw-r--r--  1 root     root       68 Nov 23 02:36 resolv.conf.ovpn3bak
-rw-r--r--  1 root     root       68 Nov 23 02:36 resolv.conf.vpn3backup <-- backup created by openvpn3-connect.sh
```

And `lsattr /etc/resolv.conf` should show an `i` attribute.

```bash
----i---------e------- /etc/resolv.conf
```

### Disconnect and restore DNS

When you’re done:

```bash
# sudo openvpn3-disconnect.sh
[+] openvpn3-disconnect.sh starting
[+] Active OpenVPN 3 session found for user 'root': /net/openvpn/v3/sessions/20d1a4a7s1c6es41f3s92a4s8196c859e189
[+] Disconnecting user session...
Initiated session shutdown.

Connection statistics:
     BYTES_IN...................13561
     BYTES_OUT..................13712
     PACKETS_IN....................47
     PACKETS_OUT...................71
     TUN_BYTES_IN................9597
     TUN_BYTES_OUT...............8989
     TUN_PACKETS_IN................61
     TUN_PACKETS_OUT...............47

[+] User session disconnected successfully
[+] Backup file found: /etc/resolv.conf.vpn3backup
[+] Removing immutable flag on /etc/resolv.conf (if set)
[+] Restoring /etc/resolv.conf from backup
[+] Removing backup file /etc/resolv.conf.vpn3backup
[+] Clearing DNS lock flag /run/openvpn3-locked.d/dnslock
[+] Re-applying permissions on /etc/resolv.conf
[+] DNS configuration restored to pre-VPN state
[+] openvpn3-disconnect.sh done
```

**This will:**
- Try to disconnect the user-owned session, then root-owned session.
- Remove the immutable flag from `/etc/resolv.conf`.
- Restore the original `/etc/resolv.conf` from `/etc/resolv.conf.vpn3backup`.
- Delete the backup and cleanup lock markers.

## Crash / power-loss recovery

If your machine crashes, power is lost, or you kill OpenVPN 3 daemons while the VPN is active, you may reboot into a state where:

- `/etc/resolv.conf` contains only VPN DNS.
- `/etc/resolv.conf` is immutable (`chattr +i`).
- There is a backup at `/etc/resolv.conf.vpn3backup`.

In all these cases, recovery is:

```bash
# sudo openvpn3-disconnect.sh
[+] openvpn3-disconnect.sh starting
[+] No active OpenVPN 3 sessions found for user or root
[+] Backup file found: /etc/resolv.conf.vpn3backup
[+] Removing immutable flag on /etc/resolv.conf (if set)
[+] Restoring /etc/resolv.conf from backup
[+] Removing backup file /etc/resolv.conf.vpn3backup
[+] Clearing DNS lock flag /run/openvpn3-locked.d/dnslock
[+] Re-applying permissions on /etc/resolv.conf
[+] DNS configuration restored to pre-VPN state
[+] openvpn3-disconnect.sh done
```

If for some reason you cannot run the script, the manual steps are:

```bash
sudo chattr -i /etc/resolv.conf
sudo cp /etc/resolv.conf.vpn3backup /etc/resolv.conf
sudo rm -f /etc/resolv.conf.vpn3backup
sudo chown root:root /etc/resolv.conf
sudo chmod 644 /etc/resolv.conf

cat /etc/resolv.conf
# Generated by NetworkManager - system provided DNS servers:
nameserver 1.1.1.1
nameserver 9.9.9.9

ls -lh /etc | grep resolv          
-rw-r--r--  1 root     root       68 Nov 23 02:47 resolv.conf
-rw-r--r--  1 root     root       53 Nov 21 14:18 resolv.conf.bak
-rw-r--r--  1 root     root       68 Nov 23 02:45 resolv.conf.ovpn3bak
```

## Security notes / disclaimers

These scripts do not guarantee perfect anonymity or prevent all possible DNS leaks. They are focused specifically on forcing your system resolver to use the DNS servers provided by your OpenVPN 3 session while it is active which is a known documented issue per what I could research when hardening my own lab machines. 

You are responsible for:
- Choosing a trustworthy VPN provider.
- Verifying your traffic behavior (e.g. with DNS leak tests).
- Making sure your system’s DNS architecture matches the assumptions described above.
- The scripts come with **no warranty** (see the MIT License). Use at your own risk.

If you have questions or feedback, you can drop me an email: eduardobarretor@gmail.com
